 # ADR-001: Использовать RFC 7807 (Problem Details) для формата ошибок
 Date: 2025-10-22
 Status: Accepted

 ## Context
 В настоящем API в разных местах возвращаются простые JSON-объекты ошибок. Необходим единый, машинно- и человекочитаемый контракт ошибок, чтобы упростить отладку, корреляцию и автоматическую обработку ошибок клиентами и шлюзами.

 ## Decision
 Принять RFC 7807 "Problem Details for HTTP APIs" в качестве стандартного формата для всех HTTP-ошибок. Включать сгенерированное поле `correlation_id` (UUID) в каждом ответе с проблемой для упрощения трассировки в логах и между сервисами.

 ## Alternatives
 - Оставить текущую неструктурированную схему ошибок (отклонено: затрудняет корреляцию и автоматическую обработку).
 - Использовать собственный JSON-контракт (отклонено: избыточная поддержка и несовместимость с существующими инструментами).

 ## Consequences
 - Клиенты будут получать структурированный payload ошибок с полями `type`, `title`, `status`, `detail` и `correlation_id`.
 - Шлюзы и системы агрегации логов смогут связывать запросы по `correlation_id`.
 - Потребуется небольшое изменение обработчиков ошибок и тестов, чтобы генерировать ответы в формате RFC7807.

 ## Security impact
 Стандартизация ошибок уменьшает вероятность случайной утечки деталей реализации и упрощает контроль над тем, какая информация возвращается клиентам.

 ## Definition of Done
 - Добавлен helper `problem()` в коде, возвращающий RFC7807 payload с `correlation_id`.
 - Зарегистрированы обработчики исключений для HTTPException и RequestValidationError.
 - Написаны тесты, проверяющие формат ответа и наличие `correlation_id`.
 - CI-проверки проходят.

 ## Rollout plan
 1. Внедрить helper и обработчики в основной ветке feature.
 2. Добавить unit/integration тесты и запустить CI.
 3. Развернуть в staging и проверить интеграцию с лог-агрегатором.
 4. Выпустить в production после успешной проверки.

 ## Owner
 - @backend-team (primary), @security-team (review)

 ## Links
 - NFR-03 (валидация данных)
 - RISKS: R5 (observability)
 - Issue #14 (RFC7807 implementation)
 - PR: will be linked after PR creation
