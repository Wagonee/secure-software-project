 # ADR-003: Безопасная обработка файлов (magic-bytes и ограничения размера)
 Date: 2025-10-22
 Status: Accepted

 ## Context
 В будущих функциях будут приниматься загружаемые файлы (изображения). Чтобы избежать подмены Content-Type и уязвимостей path traversal, обработка файлов должна проверять magic-bytes, ограничивать размер и сохранять файлы в безопасные директории.

 ## Decision
 Реализовать server-side определение типа файла по magic-bytes, задавать максимальный размер файла и хранить файлы под сгенерированными UUID-именами в контролируемой директории; отклонять операции, если в родительских каталогах есть символические ссылки.

 ## Alternatives
 - Полагаться на Content-Type из запроса (отклонено: уязвимо к спуфингу).
 - Хранить файлы в оригинальных именах пользователей (отклонено: риск path traversal и конфликта имён).

 ## Consequences
 - Безопасная обработка загружаемых файлов и уменьшение риска подмены типа и обхода безопасности через traversal.
 - Добавление тестов, проверяющих отклонение слишком больших или некорректных файлов.

 ## Security impact
 Снижает риск загрузки вредоносных файлов и защищает от уязвимостей path traversal.

 ## Definition of Done
 - Реализованы helper-функции `sniff_image_type` и `secure_save`.
 - Покрытие тестами: oversized, bad-type, path traversal, valid saves.
 - CI зелёный.

 ## Rollout plan
 1. Добавить функции в кодовую базу в feature-ветке.
 2. Написать тесты и запустить CI.
 3. Развернуть в staging, проверить логи и сохранение файлов.

 ## Owner
 - @backend-team (primary), @platform-team (review)

 ## Links
 - RISKS: R3, R5
 - Примеры в TASK (magic-bytes пример)
 - Issue #16 (secure file handling helpers)
 - PR: will be linked after PR creation
